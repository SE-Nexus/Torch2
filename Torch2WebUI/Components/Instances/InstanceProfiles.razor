@page "/instances/{InstanceId}/profiles"
@using Torch2API.Models.Configs
@using Torch2WebUI.Models
@layout InstanceLayout

@inject InstanceManager InstanceManager
<PageTitle>Instance Profiles</PageTitle>

@if (_instance is null)
{

    <MudProgressCircular Indeterminate />
    return;
}


<MudStack Spacing="3">

    <!-- 🔝 TOP BAR -->
    <MudPaper Elevation="1" Class="pa-4">
        <MudStack Row AlignItems="AlignItems.Center" Spacing="3">
            <MudText Typo="Typo.h5">
                @_instance.ProfileName
            </MudText>

            <MudChip T="string" Color="Color.Primary" Variant="Variant.Outlined">
                @_instance.TargetWorld
            </MudChip>

            <MudSpacer />

            <MudTooltip Text="@_instance.InstanceID">
                <MudIcon Icon="@Icons.Material.Filled.Fingerprint"
                         Color="Color.Secondary" />
            </MudTooltip>
        </MudStack>
    </MudPaper>

    <!-- 🔀 MAIN CONTENT -->
    <MudGrid>


        <!-- 📜 LEFT: PROFILE LIST -->
        <MudItem xs="12" md="4" lg="3">
            <MudPaper Class="pa-2" Style="height: 70vh; overflow-y: auto;">
                <MudList T="ProfileCfg" Dense="true">
                    @foreach (var profile in _instance.Profiles)
                    {
                        <MudListItem Clickable="true"
                                     Selected="@(profile == _selectedProfile)"
                                     OnClick="@(() => SelectProfile(profile))">
                            <MudStack>
                                <MudText Typo="Typo.subtitle2">
                                    @profile.InstanceName
                                </MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @profile.TargetWorld
                                </MudText>
                            </MudStack>
                        </MudListItem>
                    }
                </MudList>
            </MudPaper>
        </MudItem>


        @if (_selectedProfile != null)
        {
            <!-- 📄 RIGHT: PROFILE DETAILS -->
            <MudItem xs="12" md="8" lg="9">
                <MudPaper Class="pa-4" Style="min-height: 70vh;">
                    @if (_selectedProfile == null)
                    {
                        <MudText Color="Color.Secondary">
                            Select a profile to view details
                        </MudText>
                    }
                    else
                    {




                        <MudStack Spacing="2">
                            <MudText Typo="Typo.h5">
                                @_selectedProfile.InstanceName
                            </MudText>

                            <MudDivider />

                            <!-- TEXT -->
                            <MudTextField @bind-Value="_selectedProfile.Description"
                                          Label="Description"
                                          Variant="Variant.Outlined"
                                          FullWidth />

                            <MudTextField @bind-Value="_selectedProfile.TargetWorld"
                                          Label="Target World"
                                          Variant="Variant.Outlined"
                                          FullWidth />

                            <!-- NUMERIC -->
                            <MudNumericField T="ushort"
                                             @bind-Value="_selectedProfile.InstancePort"
                                             Label="Port"
                                             Variant="Variant.Outlined"
                                             Min="1"
                                             Max="65535" />

                            <MudNumericField T="int"
                                             @bind-Value="_selectedProfile.LogsMaxAge"
                                             Label="Logs Max Age (days)"
                                             Variant="Variant.Outlined"
                                             Min="0" />

                            <!-- SWITCHES -->
                            <MudSwitch T="bool"
                                       @bind-Checked="_selectedProfile.AutoStart"
                                       Color="Color.Primary">
                                Auto Start
                            </MudSwitch>

                            <MudSwitch T="bool" @bind-value="_selectedProfile.CheckForUpdates"
                                       Color="Color.Primary">
                                Check for Updates
                            </MudSwitch>

                            <MudSwitch T="bool" @bind-value="_selectedProfile.AutoUpdateGame"
                                       Color="Color.Primary">
                                Auto Update Game
                            </MudSwitch>

                            <MudSwitch T="bool"
                                       @bind-value="_selectedProfile.RestartOnCrash"
                                       Color="Color.Primary">
                                Restart on Crash
                            </MudSwitch>

                            <!-- BRANCH -->
                            <MudTextField @bind-Value="_selectedProfile.BranchName"
                                          Label="Game Branch"
                                          Variant="Variant.Outlined" />

                            <MudTextField @bind-Value="_selectedProfile.BranchPassword"
                                          Label="Branch Password"
                                          Variant="Variant.Outlined"
                                          InputType="InputType.Password" />



                            <MudDivider />

                            <!-- ⚙️ ACTIONS -->
                            <MudStack Row Spacing="2">
                                <MudButton Color="Color.Primary" Variant="Variant.Filled">
                                    Load Profile
                                </MudButton>

                                <MudButton Color="Color.Error" Variant="Variant.Outlined">
                                    Delete
                                </MudButton>
                            </MudStack>
                        </MudStack>

                    }
                </MudPaper>
            </MudItem>
        }



    </MudGrid>

</MudStack>






@code {
    [Parameter] public string InstanceId { get; set; } = default!;


    private MudForm? _form;
    private ProfileCfg _selectedProfile;


    private TorchInstance? _instance;

    protected override async Task OnInitializedAsync()
    {
        _instance = InstanceManager.GetInstanceByID(InstanceId);
        InstanceManager.OnChange += OnInstanceUpdated;

        await InstanceManager.SendCommand(_instance, "Config/Profiles/List");
    }

    private void OnInstanceUpdated(string updatedId)
    {
        if (updatedId != _instance.InstanceID)
            return;

        InvokeAsync(() =>
        {
            _instance = InstanceManager.GetInstanceByID(InstanceId);
            StateHasChanged();
        });
    }

    private void SelectProfile(ProfileCfg profile)
    {
        _selectedProfile = profile;
        StateHasChanged();
    }

    public void Dispose()
    {
        InstanceManager.OnChange -= OnInstanceUpdated;
    }

}
